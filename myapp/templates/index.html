{% extends 'layout/app_student.html' %}

{% load static %}
{% block body %}
  <div class="container-fluid px-4">
    <h1 class="mt-4">退除役官兵系統</h1>

    {% comment %} <div style="display: flex;">
      <a class="btn btn-sm btn-success" href="{% url 'register' %}" style="padding: 8px; float: right; background-color: green; color: white;">註冊</a>

      <a class="btn btn-sm btn-success" href="{% url 'activity_list' %}" style="padding: 8px; float: right; background-color: green; color: white;">登入</a>
    </div> {% endcomment %}

    <div class="card-header">
      <i class="fas fa-table me-1"></i>
      招生表單
    </div>
    <table id="datatablesSimple" class="rwd-table">
      <thead>
        <tr>
          <th>狀態</th>
          <th>活動名稱</th>
          <th>開始報名時間</th>
          <th>結束報名時間</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <!-- for activity loop -->
        {% for activity in activities %}
          <tr>
            <td data-th="狀態">報名中</td>
            <td data-th="活動名稱">{{ activity.name }}</td>
            <td data-th="開始報名時間">{{ activity.sign_up_start_time }}</td>
            <td data-th="結束報名時間">{{ activity.sign_up_end_time }}</td>
            <td>
              {% if request.user.is_authenticated %}
                <button class="btn btn-bg col-4 btn-success"  onclick="printData({{activity.id}})">列印報名表</button>
                <a class="btn btn-bg col-4 btn-success" href="">查看成績</a>
              {% else %}
                <a class="btn btn-bg col-12 btn-success" href="{% url 'student_join' activity.id %}">報名活動</a>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% endblock %}
{% block javascript %}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js" crossorigin="anonymous"></script>
  <script src="{% static 'assets/demo/chart-area-demo.js' %}"></script>
  <script src="{% static 'assets/demo/chart-bar-demo.js' %}"></script>
  <script src="https://cdn.jsdelivr.net/npm/simple-datatables@latest" crossorigin="anonymous"></script>
  <script src="{% static 'js/datatables-simple-demo.js' %}"></script>
  <script>
    // download join form
    function printData(activity){
      $.ajax({
        url: `{% url 'print_data' 123 %}`.replace('123', activity),
        headers: {
          'X-CSRFToken': '{{ csrf_token }}'
        },
        method: 'POST',
        xhrFields: {
          responseType: 'blob' // 设置响应类型为二进制流
      },
        success: function (data) {
          CallMessage("下載PDF成功!","success");
          // data is PDF  
          const blob = new Blob([data], { type: 'application/pdf' });

            // 创建 Blob 对象的 URL
            const blobUrl = window.URL.createObjectURL(blob);

            // 创建下载链接
            const downloadLink = document.createElement('a');
            downloadLink.href = blobUrl;
            downloadLink.download = '報名表.pdf';
            // 模拟用户点击下载链接
            document.body.appendChild(downloadLink);
            downloadLink.click();

            // 移除下载链接和 Blob URL
            document.body.removeChild(downloadLink);
            window.URL.revokeObjectURL(blobUrl);
        }
    });
  }
  </script>
{% endblock %}
